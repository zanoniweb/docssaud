<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gerador de Carnê em PDF</title>

    <style>
        /* Começo do código da estilização do menu de navegação */
        /* Reset básico */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
        }

        .navbar {
            background-color: #004080;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .logo p {
            color: white;
            font-size: 1.6em; /* Ligeiramente maior para destaque */
            font-weight: bold;
        }

        .menu ul {
            list-style: none;
            display: flex;
            gap: 20px;
        }

        .menu ul li a {
            color: white;
            text-decoration: none;
            font-size: 1em;
            transition: color 0.3s;
        }

        .menu ul li a:hover {
            color: #ffd700;
        }

        .menu-icon {
            font-size: 1.8em;
            display: none; /* Esconde o ícone de menu em telas grandes */
            cursor: pointer;
        }

        /* Esconde o checkbox */
        .menu-toggle {
            display: none;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .menu ul {
                flex-direction: column;
                position: absolute;
                top: 60px;
                right: 0;
                background-color: #004080;
                width: 100%;
                display: none; /* Oculta o menu por padrão em telas pequenas */
                z-index: 1000; /* Garante que o menu sobreponha outros elementos */
            }

            .menu ul li {
                padding: 15px;
                border-top: 1px solid rgba(255, 255, 255, 0.2);
            }

            .menu-icon {
                display: block; /* Mostra o ícone de menu em telas pequenas */
            }

            /* Quando o checkbox está marcado, mostra o menu */
            .menu-toggle:checked + .menu-icon + .menu ul {
                display: flex;
            }
        }

        /* Final do código da estilização do menu de navegação */


        body {
            font-family: 'Times New Roman', serif;
            background: #e0e0e0;
            margin: 0;
            padding: 20px; /* Padding padrão para telas maiores */
        }

        .container {
            background: white;
            max-width: 800px;
            margin: auto;
            padding: 30px 40px; /* Padding padrão para telas maiores */
            border: 1px solid #888;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
            font-size: 14px;
        }

        h2 {
            text-align: center;
            margin-bottom: 30px;
            font-family: 'Georgia', serif;
            font-size: 22px; /* Tamanho de fonte padrão para telas maiores */
            color: #222;
            text-transform: uppercase;
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            color: #333;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px 10px;
            margin-top: 6px;
            border: 1px solid #999;
            border-radius: 3px;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
            background: #fafafa;
            font-size: 13px;
        }

        textarea {
            resize: vertical;
        }

        button {
            background: #004080;
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 16px; /* Define o tamanho do texto e do ícone (graças ao 'em' no SVG) */
            padding: 12px 20px; /* Adicione padding horizontal para o ícone não colar na borda */
            margin-top: 25px;
            border-radius: 4px;
            font-weight: bold;
            transition: background 0.3s ease;
            display: flex; /* Permite alinhar o ícone e o texto lado a lado */
            align-items: center; /* Alinha verticalmente o ícone e o texto */
            justify-content: center; /* Centraliza o conteúdo (ícone + texto) no botão */
        }

        button:hover {
            background: #00264d;
        }

        /* Para tornar o SVG responsivo dentro do botão, ele já é por natureza.
        Se precisar de ajustes finos em telas menores, você pode usar media queries
        para o font-size do botão, que afetará o ícone também. */
        @media (max-width: 600px) {
            button {
                font-size: 14px; /* Diminui o texto e o ícone em telas menores */
                padding: 10px 15px; /* Ajusta o padding para telas menores */
            }
        }

        #opcoesParcelamento {
            border-left: 4px solid #ccc;
            padding-left: 15px;
            margin-top: 15px;
            background: #f3f3f3;
        }
        
        #operacaoContainer {
            display: none; /* Esconde o campo de operação por padrão */
        }

        /* --- Media Queries para Responsividade --- */

        /* Para telas pequenas (smartphones, até 600px de largura) */
        @media (max-width: 600px) {
            body {
                padding: 10px; /* Reduz o padding do corpo para aproveitar melhor o espaço */
            }

            .container {
                padding: 20px; /* Reduz o padding do container para evitar muito espaço em branco */
                box-shadow: none; /* Remove a sombra para um visual mais limpo em telas pequenas */
                border: none; /* Remove a borda para um visual mais limpo */
            }

            h2 {
                font-size: 18px; /* Diminui o tamanho do título principal */
                margin-bottom: 20px;
            }

            /* Ajustes para inputs e selects em telas pequenas, se necessário */
            input,
            select,
            textarea,
            button {
                font-size: 14px; /* Aumenta um pouco a fonte dos campos e botão para melhor legibilidade */
                padding: 10px; /* Aumenta o padding para facilitar o toque */
            }
        }

        /* Para tablets e telas médias (de 601px a 900px de largura) */
        @media (min-width: 601px) and (max-width: 900px) {
            body {
                padding: 15px;
            }

            .container {
                padding: 25px 30px;
            }

            h2 {
                font-size: 20px;
            }
        }
    </style>

</head>

<header class="navbar">
    <div class="logo">
        <p>S. G. D. C. & H.</p>
    </div>

    <input type="checkbox" id="menu-toggle" class="menu-toggle">
    <label for="menu-toggle" class="menu-icon">&#9776;</label>

    <nav class="menu">
        <ul>
            <li><a href="geracaodocumentosfinanceiros.html">Voltar Geração de Documentos</a></li>
            <li><a href="index.html">Sair</a></li>
        </ul>
    </nav>
</header>

<body>
    <div class="container">
        <h2>Gerador de Carnê em PDF</h2>

        <h3>Informações da Clínica/Hospital</h3>
        <label>Razão Social:</label>
        <input type="text" id="razao" placeholder="Ex: Clínica ABC LTDA">

        <label>CNPJ:</label>
        <input type="text" id="cnpj" placeholder="00.000.000/0000-00">

        <label>Banco:</label>
        <input type="text" id="banco" placeholder="Ex: Caixa Econômica Federal">

        <label>Agência:</label>
        <input type="text" id="agencia" placeholder="Ex: 0001">
        
        <div id="operacaoContainer">
            <label>Operação:</label>
            <input type="text" id="operacao" placeholder="Ex: 003">
        </div>
        
        <label>Conta:</label>
        <input type="text" id="conta" placeholder="Ex: 12345-6">

        <hr style="margin: 20px 0;">
        <h3>Dados do Pagamento</h3>
        <label>Valor (R$):</label>
        <input type="number" id="valor" min="0.01" step="0.01" placeholder="Ex: 1000.00">

        <label>Data Inicial de Vencimento:</label>
        <input type="date" id="dataInicial">

        <label>Observação do Pagamento:</label>
        <textarea id="observacoes" rows="4" placeholder="Ex: Consulta Dr. Mário, Cirurgia de joelho, etc."></textarea>
        
        <label>Forma de Pagamento:</label>
        <select id="tipoPagamento">
            <option value="quitacao">Quitação à vista</option>
            <option value="parcelamento">Parcelamento</option>
        </select>

        <div id="opcoesParcelamento" style="display: none;">
            <label>Quantidade de Parcelas (2 a 240):</label>
            <select id="qtdParcelas"></select>

            <label>Parcela Inicial:</label>
            <input type="number" id="parcelaInicial" min="1" placeholder="Ex: 1">

            <label>Parcela Final:</label>
            <input type="number" id="parcelaFinal" min="1" placeholder="Ex: 12">

            <label>Parcelas a Gerar (sem capa/contra capa):</label>
            <input type="number" id="qtdGeradas" min="1" placeholder="Ex: 12">
        </div>

        <hr style="margin: 20px 0;">
        <h3>Informações do Credor (Pagador)</h3>
        <label>Nome do Credor:</label>
        <input type="text" id="credor" placeholder="Ex: João da Silva">

        <label>CPF do Credor:</label>
        <input type="text" id="cpfCredor" placeholder="000.000.000-00">

        <hr style="margin: 20px 0;">
        <h3>Chave Pix</h3>
        <p>A chave Pix será usada para gerar o QR Code. Escolha o tipo de chave e digite o valor correspondente.</p>
        <label>Tipo de Chave:</label>
        <select id="pixKeyType">
            <option value="">Selecione...</option>
            <option value="cpf">CPF</option>
            <option value="cnpj">CNPJ</option>
            <option value="telefone">Telefone</option>
            <option value="email">E-mail</option>
        </select>

        <label>Chave Pix:</label>
        <input type="text" id="pixKey" placeholder="Digite a chave Pix (sem formatação)">

        <button onclick="gerarCarnePDF()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1em; height: 1em; vertical-align: middle; margin-right: 8px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            Gerar Carnê PDF
        </button>
    </div>

    <center>
        <i>
            <footer>
                <p>Web programa desenvolvido por Juliano <img src="https://d1yei2z3i6k35z.cloudfront.net/6946809/65e45ac72773e_zanoni.1.png" alt="Logo de Juliano Zanoni"></p>
            </footer>
        </i>
    </center>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        const tipo = document.getElementById('tipoPagamento');
        const op = document.getElementById('opcoesParcelamento');
        const qtdParc = document.getElementById('qtdParcelas');
        const bancoInput = document.getElementById('banco');
        const operacaoContainer = document.getElementById('operacaoContainer');

        for (let i = 2; i <= 240; i++) {
            let opt = document.createElement('option');
            opt.value = i;
            opt.textContent = `${i} parcelas`;
            qtdParc.appendChild(opt);
        }

        tipo.addEventListener('change', () => {
            op.style.display = tipo.value === 'parcelamento' ? 'block' : 'none';
        });

        // Adiciona um listener para o campo do banco para mostrar/esconder a operação
        bancoInput.addEventListener('input', toggleOperacaoField);

        function toggleOperacaoField() {
            // Converte o texto para minúsculas e remove espaços para a verificação
            const bancoNome = bancoInput.value.trim().toLowerCase();
            // Verifica se o banco é a Caixa Econômica Federal
            if (bancoNome.includes('caixa') || bancoNome.includes('cefet')) {
                operacaoContainer.style.display = 'block';
            } else {
                operacaoContainer.style.display = 'none';
            }
        }

        async function gerarCarnePDF() {
            const razao = document.getElementById('razao').value.trim();
            const cnpj = document.getElementById('cnpj').value.trim();
            const banco = document.getElementById('banco').value.trim();
            const agencia = document.getElementById('agencia').value.trim();
            const operacao = document.getElementById('operacaoContainer').style.display === 'block' ? document.getElementById('operacao').value.trim() : null;
            const conta = document.getElementById('conta').value.trim();
            const valor = parseFloat(document.getElementById('valor').value);
            const dataInicialInput = document.getElementById('dataInicial').value;
            const tipoPagamento = document.getElementById('tipoPagamento').value;
            const credor = document.getElementById('credor').value.trim();
            const cpf = document.getElementById('cpfCredor').value.trim();
            const obs = document.getElementById('observacoes').value.trim();
            const pixKeyType = document.getElementById('pixKeyType').value;
            const pixKey = document.getElementById('pixKey').value.trim();

            if (!razao || !cnpj || !banco || !agencia || !conta || isNaN(valor) || !credor || !cpf || !dataInicialInput || !pixKeyType || !pixKey) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            // Validação da operação se o campo estiver visível
            if (operacaoContainer.style.display === 'block' && !operacao) {
                alert('O número da operação é obrigatório para o banco Caixa Econômica Federal.');
                return;
            }

            const [ano, mes, dia] = dataInicialInput.split('-').map(Number);
            const dataInicio = new Date(ano, mes - 1, dia);

            let ini = 1, fim = 1, ger = 1, qtd = 1;

            if (tipoPagamento === 'parcelamento') {
                qtd = parseInt(document.getElementById('qtdParcelas').value);
                ini = parseInt(document.getElementById('parcelaInicial').value);
                fim = parseInt(document.getElementById('parcelaFinal').value);
                ger = parseInt(document.getElementById('qtdGeradas').value);

                if (isNaN(qtd) || isNaN(ini) || isNaN(fim) || isNaN(ger)) {
                    alert('Preencha todos os dados de parcelamento com números válidos.');
                    return;
                }
                
                if (ini < 1 || fim < ini || fim > qtd) {
                    alert('Erro: A parcela inicial deve ser menor ou igual à parcela final, e ambas devem estar dentro da quantidade total de parcelas.');
                    return;
                }
                
                if (ger > (fim - ini + 1)) {
                    alert('Número de parcelas a gerar excede o intervalo selecionado. Ajuste "Parcelas a Gerar".');
                    return;
                }
                if (ger < 1) {
                    alert('O número de parcelas a gerar deve ser pelo menos 1.');
                    return;
                }
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // --- Capa Comercial ---
            doc.setDrawColor(0);
            doc.setFillColor(255, 255, 255);
            doc.rect(0, 0, 210, 297, 'F');

            doc.setFillColor(0, 64, 128);
            doc.rect(0, 0, 210, 30, 'F');

            doc.setFontSize(18);
            doc.setTextColor(255, 255, 255);
            doc.setFont("helvetica", "bold");
            doc.text("CARNÊ DE PAGAMENTO", 105, 20, null, null, "center");

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(36);
            doc.setFont("helvetica", "bold");
            doc.text("CARNÊ", 105, 90, null, null, "center");
            doc.text("DE PAGAMENTO", 105, 105, null, null, "center");

            doc.setFontSize(16);
            doc.setFont("times", "normal");
            doc.text("DETALHES DA EMPRESA", 105, 140, null, null, "center");
            doc.setFontSize(12);
            doc.text(`Razão Social: ${razao}`, 105, 155, null, null, "center");
            doc.text(`CNPJ: ${cnpj}`, 105, 165, null, null, "center");

            doc.setFontSize(9);
            doc.setFont("times", "italic");
            doc.setTextColor(100, 100, 100);
            doc.text("Documento gerado automaticamente. Consulte as condições de pagamento.", 105, 285, null, null, "center");

            doc.addPage();

            // --- Contra Capa Comercial ---
            doc.setDrawColor(0);
            doc.setFillColor(255, 255, 255);
            doc.rect(0, 0, 210, 297, 'F');

            doc.setFillColor(0, 64, 128);
            doc.rect(0, 0, 210, 30, 'F');

            doc.setFontSize(18);
            doc.setTextColor(255, 255, 255);
            doc.setFont("helvetica", "bold");
            doc.text("INFORMAÇÕES ADICIONAIS", 105, 20, null, null, "center");

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("DADOS DA CLÍNICA/HOSPITAL", 20, 50);
            doc.setDrawColor(0, 64, 128);
            doc.setLineWidth(0.5);
            doc.line(20, 53, 190, 53);

            doc.setFontSize(12);
            doc.setFont("times", "normal");
            doc.text(`Razão Social: ${razao}`, 20, 65);
            doc.text(`CNPJ: ${cnpj}`, 20, 75);
            doc.text(`Banco: ${banco}`, 20, 85);
            doc.text(`Agência: ${agencia}`, 20, 95);
            if (operacao) {
                doc.text(`Operação: ${operacao}`, 20, 105);
                doc.text(`Conta: ${conta}`, 20, 115);
            } else {
                doc.text(`Conta: ${conta}`, 20, 105);
            }

            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("OBSERVAÇÕES IMPORTANTES", 20, 135);
            doc.setDrawColor(0, 64, 128);
            doc.setLineWidth(0.5);
            doc.line(20, 138, 190, 138);

            doc.setFontSize(11);
            doc.setFont("times", "normal");
            const obsLines = doc.splitTextToSize(obs || "Nenhuma observação adicional foi fornecida.", 170);
            doc.text(obsLines, 20, 150, { lineHeightFactor: 1.5 });

            doc.setFontSize(10);
            doc.setFont("times", "normal");
            doc.setTextColor(100, 100, 100);
            doc.text("Para dúvidas, entre em contato:", 20, 270);
            doc.text("E-mail:  | Telefone: (XX) XXXX-XXXX", 20, 280);

            doc.addPage();

            const valorBase = +(valor / qtd).toFixed(2);
            const totalComValorBase = valorBase * qtd;
            const diferencaAjuste = valor - totalComValorBase;
            const valorUltimaParcelaAjustado = +(valorBase + diferencaAjuste).toFixed(2);

            let contadorGeradas = 0;
            for (let i = ini; i <= fim && contadorGeradas < ger; i++) {
                const vencimento = new Date(dataInicio);
                vencimento.setMonth(vencimento.getMonth() + (i - 1));
                const vencStr = vencimento.toLocaleDateString('pt-BR');
                const valorParc = (i === qtd) ? valorUltimaParcelaAjustado : valorBase;

                doc.setDrawColor(0);
                doc.setLineWidth(0.2);
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text("Carnê de Pagamento", 80, 15);
                doc.rect(10, 20, 190, 110);

                doc.rect(10, 20, 190, 15);
                doc.setFontSize(10);
                doc.setFont("times", "normal");
                doc.text(`Razão Social: ${razao}`, 12, 28);
                doc.text(`CNPJ: ${cnpj}`, 130, 28);
                doc.text(`Banco: ${banco}`, 12, 33);
                doc.text(`Agência: ${agencia}`, 130, 33);

                doc.rect(10, 35, 190, 15);
                if (operacao) {
                    doc.text(`Operação: ${operacao}`, 12, 43);
                    doc.text(`Conta: ${conta}`, 130, 43);
                } else {
                    doc.text(`Conta: ${conta}`, 12, 43);
                }
                
                doc.rect(10, 50, 190, 15);
                doc.text(`Credor: ${credor}`, 12, 58);
                doc.text(`CPF: ${cpf}`, 130, 58);

                doc.rect(10, 65, 190, 15);
                doc.text(`Parcela: ${i} de ${qtd}`, 12, 73);
                doc.text(`Valor: R$ ${valorParc.toFixed(2)}`, 130, 73);

                const hoje = new Date().toLocaleDateString('pt-BR');
                doc.rect(10, 80, 190, 15);
                doc.text(`Emissão: ${hoje}`, 12, 88);
                doc.text(`Vencimento: ${vencStr}`, 130, 88);

                doc.rect(10, 95, 190, 35);
                
                doc.setFontSize(10);
                doc.setFont("times", "normal");
                const obsBoletoLines = doc.splitTextToSize(obs, 120);
                doc.text("Observação:", 12, 103);
                doc.text(obsBoletoLines, 12, 110, { lineHeightFactor: 1.5 });

                const qrText = `pixKey=${pixKey}&pixKeyType=${pixKeyType}&amount=${valorParc.toFixed(2)}&payerName=${credor}&description=${obs}`;
                const qrDiv = document.createElement('div');
                new QRCode(qrDiv, {
                    text: qrText,
                    width: 50,
                    height: 50,
                    correctLevel: QRCode.CorrectLevel.H
                });

                await new Promise(resolve => setTimeout(resolve, 150));

                const qrImg = qrDiv.querySelector('img') || qrDiv.querySelector('canvas');
                if (qrImg) {
                    const imgData = qrImg.tagName === 'IMG' ? qrImg.src : qrImg.toDataURL('image/png');
                    doc.addImage(imgData, 'PNG', 150, 98, 30, 30); // Posição corrigida para o QR Code
                }
                qrDiv.remove();

                contadorGeradas++;
                if (contadorGeradas < ger) {
                    doc.addPage();
                }
            }

            if (ger === 0 && doc.getNumberOfPages() > 0) {
                doc.deletePage(doc.getNumberOfPages());
            }

            doc.save('carne_pagamento.pdf');
        }
    </script>
</body>
</html>